<!DOCTYPE html>
<html>
  <head>
    <title>OpenVPN Authentication</title>
    <script src="https://accounts.google.com/gsi/client" defer></script>
    <!-- Add React and Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <!-- Inject Flask variables -->
    <script>
      window.CLIENT_ID = "{{ client_id }}";
      if (error) {
        window.AUTH_ERROR = "{{ error }}";
      }
    </script>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
  </head>
  <body>
    <div class="layout">
      <div id="drawer-root"></div>

      <!-- Error message container -->
      {% if error %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <span class="block sm:inline">{{ error }}</span>
      </div>
      {% endif %}

      <div class="main-content">
        <h1>OpenVPN Authentication Portal</h1>
        <p>To download your VPN configuration:</p>
        <ol>
          <li>Sign in with your organization account</li>
          <li>Download your personalized OpenVPN configuration file</li>
          <li>Import the configuration into your OpenVPN client</li>
        </ol>

        <!-- VPN Setup Instructions -->
        <div id="setupInstructions" style="display: none">
          <h2>VPN Setup Instructions</h2>

          <div class="tabs">
            <button class="tab-button active" onclick="window.showTab('windows')">
              Windows
            </button>
            <button class="tab-button" onclick="window.showTab('mac')">macOS</button>
            <button class="tab-button" onclick="window.showTab('linux')">Linux</button>
          </div>

          <div id="windows" class="tab-content active">
            <div class="instruction-card">
              <h3>Step 1: Download OpenVPN Client</h3>
              <a
                href="https://openvpn.net/downloads/openvpn-connect-v3-windows.msi"
                class="download-link"
              >
                Download OpenVPN Connect for Windows
              </a>
            </div>

            <div class="instruction-card">
              <h3>Step 2: Install OpenVPN Connect</h3>
              <ol>
                <li>Double-click the downloaded MSI file</li>
                <li>Follow the installation wizard</li>
                <li>Accept the default settings when prompted</li>
              </ol>
            </div>

            <div class="instruction-card">
              <h3>Step 3: Import Configuration</h3>
              <ol>
                <li>
                  Download your personal client.ovpn file using the button in
                  the left panel
                </li>
                <li>Double-click the downloaded .ovpn file</li>
                <li>
                  OpenVPN Connect will automatically import the configuration
                </li>
                <li>Click "Connect" to establish the VPN connection</li>
              </ol>
            </div>
          </div>

          <div id="mac" class="tab-content">
            <div class="instruction-card">
              <h3>Step 1: Download OpenVPN Client</h3>
              <a
                href="https://openvpn.net/downloads/openvpn-connect-v3-macos.dmg"
                class="download-link"
              >
                Download OpenVPN Connect for macOS
              </a>
            </div>

            <div class="instruction-card">
              <h3>Step 2: Install OpenVPN Connect</h3>
              <ol>
                <li>Open the downloaded .dmg file</li>
                <li>Drag OpenVPN Connect to the Applications folder</li>
                <li>Launch OpenVPN Connect from Applications</li>
                <li>Allow system extensions if prompted</li>
              </ol>
            </div>

            <div class="instruction-card">
              <h3>Step 3: Import Configuration</h3>
              <ol>
                <li>
                  Download your personal client.ovpn file using the button in
                  the left panel
                </li>
                <li>Open OpenVPN Connect</li>
                <li>
                  Drag and drop the .ovpn file into the OpenVPN Connect window
                </li>
                <li>Click "Add" to import the profile</li>
                <li>Click "Connect" to establish the VPN connection</li>
              </ol>
            </div>
          </div>

          <div id="linux" class="tab-content">
            <div class="instruction-card">
              <h3>Debian/Ubuntu Installation</h3>
              <p>Open terminal and run the following commands:</p>
              <pre>
sudo apt update
sudo apt install openvpn</pre
              >
            </div>

            <div class="instruction-card">
              <h3>Fedora/RHEL Installation</h3>
              <p>Open terminal and run the following commands:</p>
              <pre>sudo dnf install openvpn</pre>
            </div>

            <div class="instruction-card">
              <h3>Import Configuration</h3>
              <ol>
                <li>
                  Download your personal client.ovpn file using the button in
                  the left panel
                </li>
                <li>Move the configuration file to the OpenVPN directory:</li>
                <pre>sudo mv ~/Downloads/client.ovpn /etc/openvpn/client/</pre>
                <li>Start the VPN connection:</li>
                <pre>sudo openvpn --config /etc/openvpn/client/client.ovpn</pre>
                <li>Or enable it as a system service:</li>
                <pre>sudo systemctl enable --now openvpn-client@client</pre>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
      </div>
<!-- 
    <script>
      const CLIENT_ID = "{{ client_id }}";

      function showTab(tabName) {
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab-button").forEach((button) => {
          button.classList.remove("active");
        });
        document.getElementById(tabName).classList.add("active");
        document
          .querySelector(`button[onclick="showTab('${tabName}')"]`)
          .classList.add("active");
      }
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>


    <script>
        // Create React component
        const App = () => {
        const [isAuthenticated, setIsAuthenticated] = React.useState(checkAuthStatus());
        const [authToken, setAuthToken] = React.useState(null);
        const [authEmail, setAuthEmail] = React.useState(null);

        // Listen for authentication state changes
        React.useEffect(() => {
          const handleAuthState = (event) => {
            console.log('event', event)
            setIsAuthenticated(event.detail.isAuthenticated);
            setAuthToken(event.detail.token);
            setAuthEmail(event.detail.email);
          };

          window.addEventListener('authStateChanged', handleAuthState);
          return () => window.removeEventListener('authStateChanged', handleAuthState);
        }, []);

        // Download handler
        const handleDownload = async () => {
          if (!authToken) {
            alert("Please authenticate first");
            return;
          }

          try {
            const response = await fetch("/download-config", {
              headers: {
                Authorization: "Bearer " + authToken,
              },
            });

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "client.ovpn";
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
            } else {
              const error = await response.json();
              throw new Error(error.error || "Download failed");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error downloading configuration: " + error.message);
          }
        };

        return React.createElement('div', {
          className: 'w-64 h-screen bg-gray-50 border-r border-gray-200 p-6 fixed left-0 top-0'
        }, 
          React.createElement('div', {
            className: 'flex flex-col h-full'
          }, [
            // Logo Section
            React.createElement('div', {
              className: 'flex items-center space-x-2 mb-8',
              key: 'logo'
            }, [
              React.createElement('svg', {
                className: 'h-6 w-6 text-blue-600',
                viewBox: '0 0 24 24',
                fill: 'none',
                stroke: 'currentColor',
                strokeWidth: '2',
                key: 'shield-icon'
              }, 
                React.createElement('path', {
                  d: 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'
                })
              ),
              React.createElement('h2', {
                className: 'text-lg font-semibold text-gray-900'
              }, 'VPN Portal')
            ]),

            // Status Card
            React.createElement('div', {
              className: 'bg-white rounded-lg shadow-sm p-6 mb-6',
              key: 'status'
            }, [
              React.createElement('div', {
                className: 'flex items-center space-x-2 mb-4',
                key: 'status-indicator'
              }, [
                React.createElement('div', {
                  className: 'h-2 w-2 rounded-full bg-green-500'
                }),
                React.createElement('span', {
                  className: 'text-sm font-medium text-green-700'
                }, 'Server Active')
              ]),
              React.createElement('div', {
                className: 'flex items-center justify-between text-sm text-gray-600 border-t border-gray-100 pt-4',
                key: 'status-details'
              }, [
                React.createElement('span', null, 'Status'),
                React.createElement('div', {
                  className: 'flex items-center space-x-1'
                }, [
                  React.createElement('svg', {
                    className: 'h-4 w-4 text-green-500',
                    viewBox: '0 0 24 24',
                    fill: 'none',
                    stroke: 'currentColor',
                    strokeWidth: '2'
                  }, 
                    React.createElement('polyline', {
                      points: '20 6 9 17 4 12'
                    })
                  ),
                  React.createElement('span', {
                    className: 'text-green-600'
                  }, 'Operational')
                ])
              ])
            ]),

            // Auth Section
            React.createElement('div', {
              className: 'space-y-4',
              key: 'auth'
            }, 
              React.createElement('div', {
                className: 'bg-white p-4 rounded-lg shadow-sm border border-gray-200'
              }, [
                React.createElement('div', {
                  className: 'text-sm font-medium text-gray-800 mb-2',
                  key: 'auth-title'
                }, 'Authentication'),
                React.createElement('div', {
                  className: 'text-xs text-gray-600 mb-4',
                  key: 'auth-status'
                }, isAuthenticated ? `Signed in: ${authEmail}` : 'Not authenticated'),
                React.createElement('div', {
                  id: 'signInDiv',
                  className: 'w-full',
                  key: 'sign-in'
                })
              ])
            ),

            // Download Button
            React.createElement('div', {
              className: 'mt-auto',
              key: 'download'
            }, 
              React.createElement('button', {
                className: `w-full flex items-center justify-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ${
                  !isAuthenticated ? 'opacity-50 cursor-not-allowed' : ''
                }`,
                disabled: !isAuthenticated,
                onClick: handleDownload
              }, [
                React.createElement('svg', {
                  className: 'h-4 w-4',
                  viewBox: '0 0 24 24',
                  fill: 'none',
                  stroke: 'currentColor',
                  strokeWidth: '2',
                  key: 'download-icon'
                }, 
                  React.createElement('path', {
                    d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3'
                  })
                ),
                React.createElement('span', {
                  key: 'download-text'
                }, 'Download Config')
              ])
            ),

            // Footer
            React.createElement('div', {
              className: 'mt-6 text-center',
              key: 'footer'
            }, 
              React.createElement('p', {
                className: 'text-xs text-gray-500'
              }, 'OpenVPN • v2.5.1')
            )
          ])
        );
      };

      // Mount the component
      const root = ReactDOM.createRoot(document.getElementById('drawer-root'));
      root.render(React.createElement(App));
    </script> -->
  </body>
</html>
